From 3055a411d9d3dedb3c772c7d865f3a9701d99957 Mon Sep 17 00:00:00 2001
From: Eilo <eilo2518@gmail.com>
Date: Sat, 10 Mar 2012 20:27:13 -0500
Subject: [PATCH 73/74] =?UTF-8?q?2.25.2=20UtgardePinnacle:=20Skadi=20apa=C3=B1?=
 =?UTF-8?q?o=20para=20poder=20atacarle?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 .../UtgardeKeep/UtgardePinnacle/boss_skadi.cpp     |   70 ++++++++++----------
 1 files changed, 34 insertions(+), 36 deletions(-)

diff --git a/src/server/scripts/Northrend/UtgardeKeep/UtgardePinnacle/boss_skadi.cpp b/src/server/scripts/Northrend/UtgardeKeep/UtgardePinnacle/boss_skadi.cpp
index d5cd79b..fb4f0d1 100644
--- a/src/server/scripts/Northrend/UtgardeKeep/UtgardePinnacle/boss_skadi.cpp
+++ b/src/server/scripts/Northrend/UtgardeKeep/UtgardePinnacle/boss_skadi.cpp
@@ -204,8 +204,10 @@ public:
 
             Phase = SKADI;
 
+            me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+
             Summons.DespawnAll();
-            me->SetSpeed(MOVE_FLIGHT, 3.0f);
+
             if ((Unit::GetCreature((*me), m_uiGraufGUID) == NULL) && !me->IsMounted())
                  me->SummonCreature(CREATURE_GRAUF, Location[0].GetPositionX(), Location[0].GetPositionY(), Location[0].GetPositionZ(), 3.0f);
             if (m_instance)
@@ -219,7 +221,7 @@ public:
         {
             me->SetFlying(false);
             me->Dismount();
-            me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE | UNIT_FLAG_NON_ATTACKABLE);
+            me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
             if (Unit::GetCreature((*me), m_uiGraufGUID) == NULL)
                 me->SummonCreature(CREATURE_GRAUF, Location[0].GetPositionX(), Location[0].GetPositionY(), Location[0].GetPositionZ(), 3.0f);
         }
@@ -228,8 +230,6 @@ public:
         {
             DoScriptText(SAY_AGGRO, me);
 
-            me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE | UNIT_FLAG_NON_ATTACKABLE);
-
             Phase = FLYING;
 
             m_uiMovementTimer = 1000;
@@ -241,6 +241,7 @@ public:
                 m_instance->DoStartTimedAchievement(ACHIEVEMENT_TIMED_TYPE_EVENT, ACHIEV_TIMED_START_EVENT);
                 me->GetMotionMaster()->MoveJump(Location[0].GetPositionX(), Location[0].GetPositionY(), Location[0].GetPositionZ(), 5.0f, 10.0f);
                 me->RemoveUnitMovementFlag(MOVEMENTFLAG_WALKING);
+                me->SetSpeed(MOVE_FLIGHT, 3.0f);
                 m_uiMountTimer = 1000;
                 Summons.DespawnEntry(CREATURE_GRAUF);
             }
@@ -276,32 +277,6 @@ public:
             Summons.Despawn(summoned);
         }
 
-        void SpellHit(Unit* /*caster*/, const SpellInfo* spell)
-        {
-            if (spell->Id == SPELL_HARPOON_DAMAGE)
-            {
-                m_uiSpellHitCount++;
-                if (m_uiSpellHitCount >= 3)
-                {
-                    Phase = SKADI;
-                    me->SetFlying(false);
-                    me->Dismount();
-                    if (Creature* pGrauf = me->SummonCreature(CREATURE_GRAUF, me->GetPositionX(), me->GetPositionY(), me->GetPositionZ(), 0, TEMPSUMMON_CORPSE_TIMED_DESPAWN, 3*IN_MILLISECONDS))
-                    {
-                        pGrauf->GetMotionMaster()->MoveFall();
-                        pGrauf->HandleEmoteCommand(EMOTE_ONESHOT_FLYDEATH);
-                    }
-                    me->GetMotionMaster()->MoveJump(Location[4].GetPositionX(), Location[4].GetPositionY(), Location[4].GetPositionZ(), 5.0f, 10.0f);
-                    me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE | UNIT_FLAG_NON_ATTACKABLE);
-                    DoScriptText(SAY_DRAKE_DEATH, me);
-                    m_uiCrushTimer = 8000;
-                    m_uiPoisonedSpearTimer = 10000;
-                    m_uiWhirlwindTimer = 20000;
-                    me->AI()->AttackStart(SelectTarget(SELECT_TARGET_RANDOM));
-                }
-            }
-        }
-
         void UpdateAI(const uint32 diff)
         {
             switch (Phase)
@@ -310,9 +285,27 @@ public:
                     if (!UpdateVictim())
                         return;
 
-                    if (me->GetPositionX() >= 519)
+                    if (me->GetPositionX() >= 480)
                     {
-                        me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE | UNIT_FLAG_NON_ATTACKABLE);
+                        me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+                        if (m_uiSpellHitCount >= 3)
+                        {
+                           Phase = SKADI;
+                           me->SetFlying(false);
+                           me->Unmount();
+                           if(Creature* pGrauf = me->SummonCreature(CREATURE_GRAUF, me->GetPositionX(), me->GetPositionY(), me->GetPositionZ(), 0, TEMPSUMMON_CORPSE_TIMED_DESPAWN, 3*IN_MILLISECONDS))
+                           {
+                               pGrauf->GetMotionMaster()->MoveFall(0);
+                               pGrauf->HandleEmoteCommand(EMOTE_ONESHOT_FLYDEATH);
+                           }
+                           me->GetMotionMaster()->MoveJump(Location[4].GetPositionX(), Location[4].GetPositionY(), Location[4].GetPositionZ(), 5.0f, 10.0f);
+                           DoScriptText(SAY_DRAKE_DEATH, me);
+                           m_uiCrushTimer = 8000;
+                           m_uiPoisonedSpearTimer = 10000;
+                           m_uiWhirlwindTimer = 20000;
+                           me->AI()->AttackStart(SelectTarget(SELECT_TARGET_RANDOM));
+                           me->RemoveFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
+                        }
                         if (!m_bSaidEmote)
                         {
                             DoScriptText(EMOTE_RANGE, me);
@@ -321,7 +314,7 @@ public:
                     }
                     else
                     {
-                        me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NOT_SELECTABLE | UNIT_FLAG_NON_ATTACKABLE);
+                        me->SetFlag(UNIT_FIELD_FLAGS, UNIT_FLAG_NON_ATTACKABLE);
                         m_bSaidEmote = false;
                     }
 
@@ -466,9 +459,14 @@ public:
         InstanceScript* m_instance = pGO->GetInstanceScript();
         if (!m_instance) return false;
 
-        if (Creature* pSkadi = Unit::GetCreature((*pGO), m_instance->GetData64(DATA_SKADI_THE_RUTHLESS)))
-        {
-            player->CastSpell(pSkadi, SPELL_RAPID_FIRE, true);
+        Creature* pSkadi = Unit::GetCreature(*pGO, m_pInstance ? m_pInstance->GetData64(DATA_SKADI_THE_RUTHLESS) : 0);
+        if (pSkadi)
+         {
+            if (CAST_AI(boss_skadi::boss_skadiAI, pSkadi->AI())->m_bSaidEmote == true)
+            {
+                player->CastSpell(pSkadi, SPELL_RAPID_FIRE, true);
+                CAST_AI(boss_skadi::boss_skadiAI, pSkadi->AI())->m_uiSpellHitCount++;
+            }
         }
         return false;
     }
-- 
1.7.8.msysgit.0

