From 2a83a8af7be0e55aa88852c369e593a31206271c Mon Sep 17 00:00:00 2001
From: Eilo <eilo2518@gmail.com>
Date: Thu, 1 Mar 2012 12:43:09 -0500
Subject: [PATCH 20/27] 1.20 ReactState de las pets arreglado

---
 src/server/game/Entities/Unit/Unit.cpp             |   18 ++++++++++--------
 .../TargetedMovementGenerator.cpp                  |   20 ++++++++++++--------
 2 files changed, 22 insertions(+), 16 deletions(-)

diff --git a/src/server/game/Entities/Unit/Unit.cpp b/src/server/game/Entities/Unit/Unit.cpp
index 96e8978..3339619 100755
--- a/src/server/game/Entities/Unit/Unit.cpp
+++ b/src/server/game/Entities/Unit/Unit.cpp
@@ -15310,14 +15310,6 @@ void Unit::Kill(Unit* victim, bool durabilityLoss)
     if (!victim->GetHealth())
         return;
 
-    // Inform pets (if any) when player kills target)
-    if (Player* player = ToPlayer())
-    {
-        Pet* pet = player->GetPet();
-        if (pet && pet->isAlive() && pet->isControlled())
-            pet->AI()->KilledUnit(victim);
-    }
-
     // find player: owner of controlled `this` or `this` itself maybe
     Player* player = GetCharmerOrOwnerPlayerOrPlayerItself();
     Creature* creature = victim->ToCreature();
@@ -15446,6 +15438,16 @@ void Unit::Kill(Unit* victim, bool durabilityLoss)
         victim->setDeathState(JUST_DIED);
     }
 
+    // Inform pets (if any) when player kills target)
+    // MUST come after victim->setDeathState(JUST_DIED); or pet next target
+    // selection will get stuck on same target and break pet react state
+    if (Player* player = ToPlayer())
+    {
+        Pet* pet = player->GetPet();
+        if (pet && pet->isAlive() && pet->isControlled())
+            pet->AI()->KilledUnit(victim);
+    }
+
     // 10% durability loss on death
     // clean InHateListOf
     if (Player* plrVictim = victim->ToPlayer())
diff --git a/src/server/game/Movement/MovementGenerators/TargetedMovementGenerator.cpp b/src/server/game/Movement/MovementGenerators/TargetedMovementGenerator.cpp
index 964b440..3016c94 100755
--- a/src/server/game/Movement/MovementGenerators/TargetedMovementGenerator.cpp
+++ b/src/server/game/Movement/MovementGenerators/TargetedMovementGenerator.cpp
@@ -39,14 +39,18 @@ void TargetedMovementGeneratorMedium<T,D>::_setTargetLocation(T &owner)
 
     float x, y, z;
 
-    if (i_offset && i_target->IsWithinDistInMap(&owner,2*i_offset))
-    {
-        if (!owner.movespline->Finalized())
-            return;
-
-        owner.GetPosition(x, y, z);
-    }
-    else if (!i_offset)
+    //! Following block of code deleted by MrSmite in issue 4891
+    //! Code kept for learning and diagnostical purposes
+// 
+//     if (i_offset && i_target->IsWithinDistInMap(&owner,2*i_offset))
+//     {
+//         if (!owner.movespline->Finalized())
+//             return;
+// 
+//         owner.GetPosition(x, y, z);
+//     }
+//     else
+    if (!i_offset)
     {
         if (i_target->IsWithinMeleeRange(&owner))
             return;
-- 
1.7.8.msysgit.0

